<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Data Visualizer</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        input[type=text] { width: 400px; padding: 5px; }
        input[type=submit] { padding: 5px 10px; }
        .separator { margin: 1.5em 0; border-top: 1px solid #ccc; }
        #config-view { display: none; }
        #results { margin-top: 2em; }
        .error { color: red; border: 1px solid red; padding: 10px; }
        #loading { display: none; font-weight: bold; }
        #plot-img { max-width: 90%; margin-top: 1em; }
    </style>
</head>
<body>

    <div id="upload-view">
        <h2>Step 1: Upload Data</h2>
        <p>Upload a CSV file. The app will analyze its columns.</p>
        <form id="upload-form">
            <label for="file_upload">Upload a File (CSV):</label><br>
            <input type="file" id="file_upload" name="file_upload" accept=".csv" required>
            <br><br>
            <input type="submit" value="Analyze File">
        </form>
    </div>

    <div id="config-view">
        <h2>Step 2: Configure Plot</h2>
        <p>Data analyzed! We've suggested a plot, but feel free to change it.</p>
        <form id="config-form">
            <input type="hidden" id="file_id" name="file_id">
            
            <label for="plot_type">Plot Type:</label><br>
            <select id="plot_type" name="plot_type">
                <option value="line">Line Plot</option>
                <option value="bar">Bar Chart</option>
                <option value="scatter">Scatter Plot</option>
            </select>
            <br><br>

            <label for="x_col">X-Axis:</label><br>
            <select id="x_col" name="x_col" required></select>
            <br><br>

            <label for="y_col">Y-Axis:</label><br>
            <select id="y_col" name="y_col" required></select>
            <br><br>

            <input type="submit" value="Generate Plot">
        </form>
    </div>

    <div id="results">
        <div id="loading">Loading...</div>
    </div>

    <script>
        const uploadView = document.getElementById('upload-view');
        const uploadForm = document.getElementById('upload-form');
        const configView = document.getElementById('config-view');
        const configForm = document.getElementById('config-form');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        uploadForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            resultsDiv.appendChild(loadingDiv);
            const formData = new FormData(uploadForm);
            try {
                const response = await fetch('/upload_and_analyze', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.error) {
                    showError(data.error);
                } else {
                    buildConfigForm(data.columns, data.file_id, data.suggestions);
                }
            } catch (err) {
                showError(`Network Error: ${err.message}`);
            }
        });
        function buildConfigForm(columns, fileId, suggestions) {
            const xColSelect = document.getElementById('x_col');
            const yColSelect = document.getElementById('y_col');
            const plotTypeSelect = document.getElementById('plot_type');
            document.getElementById('file_id').value = fileId;
            xColSelect.innerHTML = '<option value="">-- Select X-Axis --</option>';
            yColSelect.innerHTML = '<option value="">-- Select Y-Axis --</option>';
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                xColSelect.appendChild(option.cloneNode(true));
                yColSelect.appendChild(option.cloneNode(true));
            });
            plotTypeSelect.value = suggestions.plot_type;
            xColSelect.value = suggestions.x_col;
            yColSelect.value = suggestions.y_col;
            loadingDiv.style.display = 'none';
            uploadView.style.display = 'none';
            configView.style.display = 'block';
        }
        configForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            resultsDiv.appendChild(loadingDiv);
            const formData = new FormData(configForm);
            const config = {
                file_id: formData.get('file_id'),
                plot_type: formData.get('plot_type'),
                x_col: formData.get('x_col'),
                y_col: formData.get('y_col')
            };
            try {
                const response = await fetch('/plot_dynamic', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                loadingDiv.style.display = 'none';
                if (data.error) {
                    showError(data.error);
                } else if (data.img_data) {
                    resultsDiv.innerHTML = `
                        <img src="data:image/png;base64,${data.img_data}" 
                             alt="Plot of ${config.x_col} vs ${config.y_col}" id="plot-img">
                    `;
                }
            } catch (err) {
                showError(`Network Error: ${err.message}`);
            }
        });
        
        // --- Helper function to show errors ---
        function showError(message) {
            loadingDiv.style.display = 'none';
            // --- TYPO FIX HERE ---
            resultsDiv.innerHTML = `<div class="error">
                <strong>Error:</strong> ${message}
            </div>`;
        }
    </script>
</body>
</html>